<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PokeMonster</title>
    <style>
        html, body{
            overflow: hidden;
            width:100%;
            height:100%;
            margin:0;
            padding:0;
            border:0;
        }
    </style>
    <script src="js/ImageManager.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/world.js"></script>
    <script src="js/Human.js"></script>
    <script src="js/MapRenderer.js"></script>
    <script src="js/Animator.js"></script>
    <script src="js/WorldObject.js"></script>
    <script>
        var canvas;
        var ctx;
        var imageManager;
        var mapRenderer;
        var spriteSheet;
        var worldObject;

        var obj = [];
        var id = 0;
        var speed = 32;
        var moveX = 0;
        var moveY = 0;
        var frame = 0;
        var numFrames = 4;
        var duration = numFrames * 250;
        var frameStart = 0;
        var currentFrame = 0;

        var images = {
            "house" : "img/house.png",
            "outside" : "img/outside.png",
            "outside2" : "img/outside2.png",
            "man" : "img/RM.png"
        };
        function init(){
            imageManager = new ImageManager();
            imageManager.load(images, onLoaded);

            canvas = initFullScreenCanvas("mainCanvas");
            ctx = canvas.getContext("2d");

            /*
             Left Arrow 	37
             Up Arrow 	38
             Right Arrow 	39
             Dw Arrow 	40
             */
           window.onkeypress = function (e) {
                   if(e.keyCode == 38){
                       if(canMove(0 , -speed))
                       mapRenderer.move(moveX, speed);
                       frame = 3;
                   }else if (e.keyCode == 40){
                       if(canMove(0 , speed))
                       mapRenderer.move(moveX,-speed);
                       frame = 0;
                   }else if (e.keyCode == 37){
                       if(canMove(-speed , 0))
                       mapRenderer.move( speed, moveY);
                       frame = 1;
                   }else if (e.keyCode ==39){
                       if(canMove(speed , 0))
                       mapRenderer.move( -speed, moveY);
                       frame = 2;
                   };

            };
        }

        //图像加载完后回调;
        function onLoaded(){

            mapRenderer = new MapRenderer(world, imageManager.get("house"),32,canvas.width,canvas.height);
            spriteSheet = new SpriteSheet(imageManager.get("man"), Human);
            spriteSheet.drawFrame(ctx, 0,0, window.screen.width/2 ,window.screen.height/2);
            for(var y = 0; y<world.length ;y++){
                for(var x = 0; x<world[y].length;x++){
                    var tileId = world[y][x]-1;

                    if((tileId <=10 && tileId >=0 )|| (tileId >13 && tileId <20) || (tileId >23 && tileId <30))
                        continue;
                    else {
                        var wo = new WorldObject(id , x*32 ,y*32);
                        obj.push(wo);
                      // console.log(tileId + "," +obj[id]._x +","+ obj[id]._y);
                        id++;
                    }

                }
            };

            animate(0);
        }

        function animate(t){
            clear();
            mapRenderer.draw(ctx);

            var now = t || new Date().getTime();
            var passed = (now - frameStart)%duration;
            var currentFrame = Math.floor((passed/duration)*numFrames);

            spriteSheet.drawFrame(ctx, frame, currentFrame, window.screen.width/2 ,window.screen.height/2);
            requestAnimationFrame(arguments.callee);
        }

        function canMove(x, y){
            var px = Math.floor((-mapRenderer._x + window.screen.width/2 +x) / 32);
            var py = Math.floor((-mapRenderer._y + window.screen.height/2+y)/ 32);
            var tileID = world[py][px] -1;
            console.log(x +","+y+"||"+tileID);
            if ((tileID > -1 && tileID < 11) || (tileID > 13 && tileID < 20) || (tileID > 23 && tileID < 30)){
                return true;
            }
            return false;
        }
 /*       function onMove(){
            console.log(moveX+","+moveY);
            mapRenderer.move(moveX, moveY);
        }*/

        function clear(){
            //填充画布
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width , canvas.height);
        }
        function  initFullScreenCanvas(canvasId){
            var canvas = document.getElementById(canvasId);
            resizeCanvas(canvas);
            window.addEventListener("resize" , function () {
                resizeCanvas(canvas);
            });
            return canvas;
        }

        function resizeCanvas(canvas){
            canvas.width = document.width || document.body.clientWidth;
            canvas.height = document.height || document.body.clientHeight;
            mapRenderer && mapRenderer.setViewportSize(canvas.width , canvas.height);
        }
    </script>
</head>
<body onload="init()">
    <canvas id="mainCanvas" width="400" height="300" ></canvas>
</body>
</html>